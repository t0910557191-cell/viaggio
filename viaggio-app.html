<!DOCTYPE html>
<html lang="zh-TW"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>VIAGGIO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Cinzel:wght@400;500&display=swap" rel="stylesheet">
<style>
html,body{margin:0;padding:0;background:#0f0d0a;min-height:100vh}
*{box-sizing:border-box}
::-webkit-scrollbar{width:0}
input[type=date]::-webkit-calendar-picker-indicator{filter:invert(.6)}
select option{background:#1a1710;color:#e8dcc8}
</style>
</head><body>
<div id="root"></div>
<script type="text/babel">

const {useState, useRef, useEffect} = React;

// â”€â”€ CONSTANTS â”€â”€
const CURR = ['CNY Â¥','EUR â‚¬','USD $','TWD NT$','CAD C$'];
// Base rates to USD (used as fallback, user can override any pair)
const BASE_FX = {'CNY Â¥':0.138,'EUR â‚¬':1.085,'USD $':1,'TWD NT$':0.031,'CAD C$':0.74};
const SRC_TYPES = ['å°ç´…æ›¸','éƒ¨è½æ ¼','YouTube','Google Maps','Tripadvisor','å®˜æ–¹ç¶²ç«™','IG','å…¶ä»–'];
const SRC_CLR = {'å°ç´…æ›¸':'#e05a5a','éƒ¨è½æ ¼':'#7a9b6a','YouTube':'#c0504d','Google Maps':'#6a9bc0','Tripadvisor':'#3a9b7a','å®˜æ–¹ç¶²ç«™':'#8b7355','IG':'#9b7a8a','å…¶ä»–':'#7a8a7a'};
const GUIDE_CATS = ['é¤å»³','å’–å•¡å»³','åšç‰©é¤¨/å±•è¦½','ä½å®¿','æ™¯é»/æ‰“å¡','äº¤é€š','è³¼ç‰©','ç¶œåˆ','å…¶ä»–'];
const GUIDE_CLR = {'é¤å»³':'#7a9b6a','å’–å•¡å»³':'#8b7355','åšç‰©é¤¨/å±•è¦½':'#6a7a9b','ä½å®¿':'#9b8a6a','æ™¯é»/æ‰“å¡':'#d4a853','äº¤é€š':'#7a8a9b','è³¼ç‰©':'#9b7a8a','ç¶œåˆ':'#8a7a9b','å…¶ä»–':'#7a8a7a'};
const EXP_CATS = ['ä½å®¿','é¤é£²','äº¤é€š','æ™¯é»é–€ç¥¨','è³¼ç‰©','å…¶ä»–'];
const EXP_CLR = {'ä½å®¿':'#8b7355','é¤é£²':'#7a9b6a','äº¤é€š':'#6a7a9b','æ™¯é»é–€ç¥¨':'#9b8a6a','è³¼ç‰©':'#9b7a8a','å…¶ä»–':'#7a8a7a'};
const STATUS = ['æœªè®€','å·²è®€','å·²å»é âœ“'];
const SCLR = {'æœªè®€':'#6b5f4a','å·²è®€':'#8a9b6a','å·²å»é âœ“':'#d4a853'};
const STAR_LABELS = ['','å·®','æ™®é€š','é‚„å¯ä»¥','æ¨è–¦','å¿…å»ï¼'];

// â”€â”€ TRANSLATIONS â”€â”€
const TR = {
  'ç¹ä¸­': {
    tabs:['äº¤é€š','æ”»ç•¥','æ—¥è¨˜','èŠ±è²»','çµ±è¨ˆ','è¨­å®š'],
    from:'å‡ºç™¼åœ°', to:'ç›®çš„åœ°', openMaps:'é–‹å•Ÿ Google Maps',
    saveLog:'å„²å­˜è¡Œç¨‹', tripLog:'è¡Œç¨‹è¨˜éŒ„', estTime:'é ä¼°æ™‚é–“',
    cost:'è²»ç”¨', note:'å‚™æ³¨', del:'åˆª', edit:'ç·¨', save:'å„²å­˜', cancel:'å–æ¶ˆ',
    addSrc:'+ æ–°å¢æ”»ç•¥', noSources:'æš«ç„¡æ”»ç•¥ï¼Œé»å³ä¸Šè§’æ–°å¢',
    filterCity:'ğŸ” åŸå¸‚...', allCats:'æ‰€æœ‰åˆ†é¡', allStatus:'æ‰€æœ‰ç‹€æ…‹',
    city:'åŸå¸‚', country:'åœ‹å®¶', date:'æ—¥æœŸ', rating:'è©•åˆ†',
    comment:'å¿ƒå¾—', tags:'æ¨™ç±¤', shop:'åº—å/åœ°é»',
    category:'é¡åˆ¥', amount:'é‡‘é¡', currency:'å¹£åˆ¥',
    addDiary:'+ å¯«æ—¥è¨˜', diaryTitle:'æ—…è¡Œæ—¥è¨˜',
    addExp:'+ æ–°å¢', expTitle:'èŠ±è²»è¨˜éŒ„',
    yearTotal:'ä»Šå¹´æ—…éŠç¸½èŠ±è²»', monthly:'æ¯æœˆ', byCity:'æ¯åŸå¸‚',
    guideStats:'æ”»ç•¥çµ±è¨ˆ', fx:'åŒ¯ç‡', commute:'é€šå‹¤',
    mapsInfo:'âœ“ é»æŸ¥è©¢ç›´æ¥é–‹å•Ÿ Google Mapsï¼ŒæŸ¥çœ‹çœŸå¯¦ç­æ¬¡èˆ‡ç¥¨åƒ¹',
    saveResult:'å·²é–‹å•Ÿ Google Mapsï¼Œå¯æ‰‹å‹•å¡«å…¥æ™‚é–“èˆ‡è²»ç”¨',
    transport:'è·¯ç·šæŸ¥è©¢', srcTitle:'æ¨™é¡Œ/åç¨±', srcType:'ä¾†æºé¡å‹',
    url:'ä¾†æº URLï¼ˆé¸å¡«ï¼‰', status:'ç‹€æ…‹', personalNote:'å€‹äººå‚™æ³¨',
    templateTitle:'æ”»ç•¥æ¨¡æ¿', tBasic:'åŸºæœ¬è³‡è¨Š', tTransport:'äº¤é€š',
    tFood:'é£²é£Ÿæ¨è–¦', tSights:'æ™¯é»é–€ç¥¨', tStay:'ä½å®¿',
    tSecret:'å€‹äººç§˜ç¬ˆ', tTrust:'å¯ä¿¡åº¦è©•åˆ†',
    nearestAirport:'æœ€è¿‘æ©Ÿå ´', howToGet:'é€ è¨ªæ–¹å¼',
    transportTips:'äº¤é€šå»ºè­°', mustEat:'å¿…åƒæ¨è–¦', discount:'å„ªæƒ å‘¼è¦–',
    bestTime:'æœ€ä½³ç©ºè…¹æ™‚é–“', ticketPrice:'é–€ç¥¨åƒ¹æ ¼', openHours:'é–‹æ”¾æ™‚é–“',
    queueTip:'æ’éšŠå»ºè­°', stayArea:'å»ºè­°ä½å®¿å€åŸŸ', stayNote:'ä½å®¿æ³¨æ„äº‹é …',
    myTips:'æˆ‘çš„ç§æˆ¿Tips', specialReminder:'ç‰¹åˆ¥æé†’',
    trustScore:'å°æ­¤æ”»ç•¥çš„ä¿¡ä»»åº¦', freeNote:'è‡ªç”±å‚™æ³¨',
    currency2:'å¹£åˆ¥',
    // FX
    fxTitle:'åŒ¯ç‡æ›ç®—', calcTitle:'å³æ™‚æ›ç®—',
    fxFrom:'å¾', fxTo:'åˆ°', fxAmt:'é‡‘é¡',
    pairEdit:'æ‰‹å‹•è¨­å®šåŒ¯ç‡', pairFrom:'å¹£åˆ¥ A', pairTo:'å¹£åˆ¥ B',
    pairRate:'1 A = ? B', setPair:'è¨­å®š', resetFx:'æ¢å¾©é è¨­',
    fxNote:'âš  è‡ªè¨‚åŒ¯ç‡åƒ…æœ¬æ¬¡ä½¿ç”¨ï¼Œé‡æ–°æ•´ç†å¾Œæ¢å¾©é è¨­',
    // Settings (preferences only)
    settingsTitle:'åå¥½è¨­å®š',
    defCurrency:'é è¨­å¹£åˆ¥', defLang:'é è¨­èªè¨€',
    themeNote:'æ›´å¤šè¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­',
    tripName:'æ—…ç¨‹åç¨±ï¼ˆé¸å¡«ï¼‰',
    appInfo1:'è³‡æ–™ï¼ˆå«ç…§ç‰‡ï¼‰è‡ªå‹•å­˜æ–¼ç€è¦½å™¨ï¼Œæ¸…é™¤ cookies æ‰æœƒæ¶ˆå¤±',
    appInfo2:'èŠ±è²»èˆ‡æ—¥è¨˜å¯åŒ¯å‡º CSV',
    appInfo3:'äº¤é€šåŠŸèƒ½ä¸²æ¥ Google Mapsï¼ˆå…è²»ï¼‰',
    clearData:'æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼ˆé‡ç½® Appï¼‰',
    clearConfirm:'ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚',
  },
  'ç®€ä¸­': {
    tabs:['äº¤é€š','æ”»ç•¥','æ—¥è®°','èŠ±è´¹','ç»Ÿè®¡','è®¾å®š'],
    from:'å‡ºå‘åœ°', to:'ç›®çš„åœ°', openMaps:'å¼€å¯ Google Maps',
    saveLog:'ä¿å­˜è¡Œç¨‹', tripLog:'è¡Œç¨‹è®°å½•', estTime:'é¢„ä¼°æ—¶é—´',
    cost:'è´¹ç”¨', note:'å¤‡æ³¨', del:'åˆ ', edit:'ç¼–', save:'ä¿å­˜', cancel:'å–æ¶ˆ',
    addSrc:'+ æ–°å¢æ”»ç•¥', noSources:'æš‚æ— æ”»ç•¥ï¼Œç‚¹å³ä¸Šè§’æ–°å¢',
    filterCity:'ğŸ” åŸå¸‚...', allCats:'æ‰€æœ‰åˆ†ç±»', allStatus:'æ‰€æœ‰çŠ¶æ€',
    city:'åŸå¸‚', country:'å›½å®¶', date:'æ—¥æœŸ', rating:'è¯„åˆ†',
    comment:'å¿ƒå¾—', tags:'æ ‡ç­¾', shop:'åº—å/åœ°ç‚¹',
    category:'ç±»åˆ«', amount:'é‡‘é¢', currency:'å¸åˆ«',
    addDiary:'+ å†™æ—¥è®°', diaryTitle:'æ—…è¡Œæ—¥è®°',
    addExp:'+ æ–°å¢', expTitle:'èŠ±è´¹è®°å½•',
    yearTotal:'ä»Šå¹´æ—…æ¸¸æ€»èŠ±è´¹', monthly:'æ¯æœˆ', byCity:'æ¯åŸå¸‚',
    guideStats:'æ”»ç•¥ç»Ÿè®¡', fx:'æ±‡ç‡', commute:'é€šå‹¤',
    mapsInfo:'âœ“ ç‚¹æŸ¥è¯¢ç›´æ¥å¼€å¯ Google Mapsï¼ŒæŸ¥çœ‹çœŸå®ç­æ¬¡ä¸ç¥¨ä»·',
    saveResult:'å·²å¼€å¯ Google Mapsï¼Œå¯æ‰‹åŠ¨å¡«å…¥æ—¶é—´å’Œè´¹ç”¨',
    transport:'è·¯çº¿æŸ¥è¯¢', srcTitle:'æ ‡é¢˜/åç§°', srcType:'æ¥æºç±»å‹',
    url:'æ¥æº URLï¼ˆé€‰å¡«ï¼‰', status:'çŠ¶æ€', personalNote:'ä¸ªäººå¤‡æ³¨',
    templateTitle:'æ”»ç•¥æ¨¡æ¿', tBasic:'åŸºæœ¬ä¿¡æ¯', tTransport:'äº¤é€š',
    tFood:'é¥®é£Ÿæ¨è', tSights:'æ™¯ç‚¹é—¨ç¥¨', tStay:'ä½å®¿',
    tSecret:'ä¸ªäººç§˜ç¬ˆ', tTrust:'å¯ä¿¡åº¦è¯„åˆ†',
    nearestAirport:'æœ€è¿‘æœºåœº', howToGet:'é€ è®¿æ–¹å¼',
    transportTips:'äº¤é€šå»ºè®®', mustEat:'å¿…åƒæ¨è', discount:'ä¼˜æƒ å‘¼è§†',
    bestTime:'æœ€ä½³ç©ºè…¹æ—¶é—´', ticketPrice:'é—¨ç¥¨ä»·æ ¼', openHours:'å¼€æ”¾æ—¶é—´',
    queueTip:'æ’é˜Ÿå»ºè®®', stayArea:'å»ºè®®ä½å®¿åŒºåŸŸ', stayNote:'ä½å®¿æ³¨æ„äº‹é¡¹',
    myTips:'æˆ‘çš„ç§æˆ¿Tips', specialReminder:'ç‰¹åˆ«æé†’',
    trustScore:'å¯¹æ­¤æ”»ç•¥çš„ä¿¡ä»»åº¦', freeNote:'è‡ªç”±å¤‡æ³¨',
    currency2:'å¸åˆ«',
    fxTitle:'æ±‡ç‡æ¢ç®—', calcTitle:'å³æ—¶æ¢ç®—',
    fxFrom:'ä»', fxTo:'åˆ°', fxAmt:'é‡‘é¢',
    pairEdit:'æ‰‹åŠ¨è®¾å®šæ±‡ç‡', pairFrom:'å¸åˆ« A', pairTo:'å¸åˆ« B',
    pairRate:'1 A = ? B', setPair:'è®¾å®š', resetFx:'æ¢å¤é»˜è®¤',
    fxNote:'âš  è‡ªå®šæ±‡ç‡ä»…æœ¬æ¬¡ä½¿ç”¨',
    settingsTitle:'åå¥½è®¾ç½®',
    defCurrency:'é»˜è®¤å¸åˆ«', defLang:'é»˜è®¤è¯­è¨€',
    themeNote:'æ›´å¤šè®¾ç½®åŠŸèƒ½å¼€å‘ä¸­',
    tripName:'æ—…ç¨‹åç§°ï¼ˆé€‰å¡«ï¼‰',
    appInfo1:'æ•°æ®ï¼ˆå«ç…§ç‰‡ï¼‰è‡ªåŠ¨å­˜äºæµè§ˆå™¨ï¼Œæ¸…é™¤ cookies æ‰ä¼šæ¶ˆå¤±',
    appInfo2:'èŠ±è´¹ä¸æ—¥è®°å¯å¯¼å‡º CSV',
    appInfo3:'äº¤é€šåŠŸèƒ½è¿æ¥ Google Mapsï¼ˆå…è´¹ï¼‰',
    clearData:'æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆé‡ç½® Appï¼‰',
    clearConfirm:'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚',
  },
  'EN': {
    tabs:['Transport','Guide','Diary','Expenses','Stats','Settings'],
    from:'From', to:'To', openMaps:'Open Google Maps',
    saveLog:'Save Trip', tripLog:'Trip Log', estTime:'Est. Time',
    cost:'Cost', note:'Note', del:'Del', edit:'Edit', save:'Save', cancel:'Cancel',
    addSrc:'+ Add Guide', noSources:'No guides yet â€” add one top right',
    filterCity:'ğŸ” City...', allCats:'All Categories', allStatus:'All Status',
    city:'City', country:'Country', date:'Date', rating:'Rating',
    comment:'Comment', tags:'Tags', shop:'Shop / Place',
    category:'Category', amount:'Amount', currency:'Currency',
    addDiary:'+ Write', diaryTitle:'Travel Diary',
    addExp:'+ Add', expTitle:'Expenses',
    yearTotal:"This Year's Travel Spend", monthly:'Monthly', byCity:'By City',
    guideStats:'Guide Stats', fx:'Currency', commute:'Commute',
    mapsInfo:'âœ“ Opens Google Maps â€” see real schedules & prices',
    saveResult:'Google Maps opened â€” fill in time & cost manually',
    transport:'Route Search', srcTitle:'Title / Name', srcType:'Source Type',
    url:'Source URL (optional)', status:'Status', personalNote:'Personal Note',
    templateTitle:'Guide Template', tBasic:'Basic Info', tTransport:'Transport',
    tFood:'Food & Drinks', tSights:'Attractions', tStay:'Accommodation',
    tSecret:'My Tips', tTrust:'Trust Rating',
    nearestAirport:'Nearest Airport', howToGet:'How to Get There',
    transportTips:'Transport Tips', mustEat:'Must Eat', discount:'Deals & Discounts',
    bestTime:'Best Time to Visit', ticketPrice:'Ticket Price', openHours:'Opening Hours',
    queueTip:'Queue Tips', stayArea:'Recommended Area', stayNote:'Accommodation Notes',
    myTips:'My Secret Tips', specialReminder:'Special Reminders',
    trustScore:'Trust Score', freeNote:'Free Notes',
    currency2:'Currency',
    fxTitle:'Currency', calcTitle:'Quick Convert',
    fxFrom:'From', fxTo:'To', fxAmt:'Amount',
    pairEdit:'Set Exchange Rate', pairFrom:'Currency A', pairTo:'Currency B',
    pairRate:'1 A = ? B', setPair:'Set', resetFx:'Reset to Default',
    fxNote:'âš  Custom rates apply to this session only',
    settingsTitle:'Preferences',
    defCurrency:'Default Currency', defLang:'Default Language',
    themeNote:'More settings coming soon',
    tripName:'Trip Name (optional)',
    appInfo1:'Data (incl. photos) saved in browser â€” cleared only if you clear cookies',
    appInfo2:'Expenses & diary can be exported as CSV',
    appInfo3:'Transport uses Google Maps (free)',
    clearData:'Clear All Data (Reset App)',
    clearConfirm:'Are you sure you want to clear all data? This cannot be undone.',
  },
  'IT': {
    tabs:['Trasporti','Guida','Diario','Spese','Statistiche','Impostazioni'],
    from:'Partenza', to:'Destinazione', openMaps:'Apri Google Maps',
    saveLog:'Salva Viaggio', tripLog:'Registro', estTime:'Tempo stimato',
    cost:'Costo', note:'Nota', del:'Elm', edit:'Mod', save:'Salva', cancel:'Annulla',
    addSrc:'+ Aggiungi', noSources:'Nessuna guida â€” aggiungi in alto a destra',
    filterCity:'ğŸ” CittÃ ...', allCats:'Tutte', allStatus:'Tutti gli stati',
    city:'CittÃ ', country:'Paese', date:'Data', rating:'Voto',
    comment:'Commento', tags:'Tag', shop:'Negozio/Luogo',
    category:'Categoria', amount:'Importo', currency:'Valuta',
    addDiary:'+ Scrivi', diaryTitle:'Diario',
    addExp:'+ Aggiungi', expTitle:'Spese',
    yearTotal:'Spese annuali viaggi', monthly:'Mensile', byCity:'Per cittÃ ',
    guideStats:'Guide', fx:'Valute', commute:'Tragitti',
    mapsInfo:'âœ“ Apre Google Maps â€” orari e prezzi reali',
    saveResult:'Google Maps aperto â€” inserisci tempo e costo',
    transport:'Cerca percorso', srcTitle:'Titolo', srcType:'Tipo fonte',
    url:'URL fonte (opzionale)', status:'Stato', personalNote:'Nota personale',
    templateTitle:'Modello Guida', tBasic:'Info Base', tTransport:'Trasporti',
    tFood:'Cibo & Bevande', tSights:'Attrazioni', tStay:'Alloggio',
    tSecret:'Consigli Segreti', tTrust:'AffidabilitÃ ',
    nearestAirport:'Aeroporto piÃ¹ vicino', howToGet:'Come arrivarci',
    transportTips:'Consigli trasporti', mustEat:'Da mangiare assolutamente', discount:'Offerte',
    bestTime:'Orario migliore', ticketPrice:'Prezzo biglietto', openHours:'Orari apertura',
    queueTip:'Consigli fila', stayArea:'Zona consigliata', stayNote:'Note alloggio',
    myTips:'I miei consigli segreti', specialReminder:'Promemoria speciali',
    trustScore:'AffidabilitÃ ', freeNote:'Note libere',
    currency2:'Valuta',
    fxTitle:'Valute', calcTitle:'Conversione rapida',
    fxFrom:'Da', fxTo:'A', fxAmt:'Importo',
    pairEdit:'Imposta tasso di cambio', pairFrom:'Valuta A', pairTo:'Valuta B',
    pairRate:'1 A = ? B', setPair:'Imposta', resetFx:'Ripristina',
    fxNote:'âš  Tassi personalizzati solo per questa sessione',
    settingsTitle:'Preferenze',
    defCurrency:'Valuta predefinita', defLang:'Lingua predefinita',
    themeNote:'Altre impostazioni in arrivo',
    tripName:'Nome viaggio (opzionale)',
    appInfo1:'Dati (foto incluse) salvati nel browser â€” si cancellano solo svuotando i cookie',
    appInfo2:'Spese e diario esportabili in CSV',
    appInfo3:'Trasporti collegati a Google Maps (gratuito)',
    clearData:'Cancella tutti i dati (Reset App)',
    clearConfirm:'Sei sicuro di voler cancellare tutti i dati? Questa azione Ã¨ irreversibile.',
  },
};

// â”€â”€ HELPERS â”€â”€
function csvDl(rows, fn) {
  if (!rows.length) return;
  const h = Object.keys(rows[0]);
  const body = rows.map(r => h.map(k => '"' + String(r[k]||'').replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + h.join(',') + '\n' + body], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fn; a.click();
}
function readImg(file) {
  return new Promise(res => {
    const r = new FileReader();
    r.onload = e => {
      const img = new Image();
      img.onload = () => {
        const MAX = 1200;
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else { w = Math.round(w * MAX / h); h = MAX; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        res({url: canvas.toDataURL('image/jpeg', 0.7), name: file.name});
      };
      img.src = e.target.result;
    };
    r.readAsDataURL(file);
  });
}

// â”€â”€ STYLE â”€â”€
const G = {
  bg:'#0f0d0a', bg2:'#141210', bg3:'#1a1710', bg4:'#0d0b08',
  gold:'#d4a853', text:'#e8dcc8', sub:'#9a8968', dim:'#6b5f4a',
  br:'#2a2418', br2:'#1e1b14', red:'#9b6a6a', green:'#7a9b6a',
};
const S = {
  inp: {background:G.bg3, border:'1px solid '+G.br, color:G.text, padding:'10px 14px', fontFamily:"'Cormorant Garamond',serif", fontSize:15, borderRadius:2, width:'100%', outline:'none'},
  ta:  {background:G.bg3, border:'1px solid '+G.br, color:G.text, padding:'10px 14px', fontFamily:"'Cormorant Garamond',serif", fontSize:14, borderRadius:2, width:'100%', resize:'vertical', outline:'none'},
  gold:{background:G.gold, color:G.bg, border:'none', padding:'10px 18px', fontFamily:"'Cinzel',serif", letterSpacing:2, cursor:'pointer', borderRadius:2, fontSize:10},
  out: {background:'transparent', color:G.gold, border:'1px solid '+G.gold, padding:'9px 14px', fontFamily:"'Cinzel',serif", letterSpacing:2, cursor:'pointer', borderRadius:2, fontSize:12},
  gh:  {background:'transparent', color:G.dim, border:'1px solid '+G.br, padding:'7px 12px', fontFamily:"'Cinzel',serif", letterSpacing:1, cursor:'pointer', borderRadius:2, fontSize:12},
  rd:  {background:'transparent', color:G.red, border:'1px solid rgba(155,106,106,.3)', padding:'6px 10px', fontFamily:"'Cinzel',serif", letterSpacing:1, cursor:'pointer', borderRadius:2, fontSize:10},
  card:{border:'1px solid '+G.br2, borderRadius:4, padding:14, marginBottom:10, background:G.bg},
};
const CZ = {fontFamily:"'Cinzel',serif"};
const chip = (on, clr) => ({...CZ, fontSize:13, letterSpacing:1, cursor:'pointer', padding:'5px 11px', borderRadius:2, whiteSpace:'nowrap', border:'1px solid '+(on?(clr||G.gold):'#3a3020'), background:on?(clr||G.gold)+'18':'transparent', color:on?(clr||G.gold):G.sub});
const Lbl = ({t}) => <div style={{fontSize:12, color:G.dim, letterSpacing:1, ...CZ, marginBottom:6}}>{t}</div>;
const HR = () => <span style={{flex:1, height:1, background:G.br, display:'block'}}/>;
const SecHead = ({t, children}) => (
  <div style={{display:'flex', alignItems:'center', gap:10, marginBottom:14}}>
    <span style={{...CZ, fontSize:11, letterSpacing:2, color:G.dim}}>{t}</span><HR/>{children}
  </div>
);

// â”€â”€ MODAL â”€â”€
function Modal({show, onClose, title, children}) {
  if (!show) return null;
  return (
    <div style={{position:'fixed', inset:0, background:'rgba(0,0,0,.93)', display:'flex', alignItems:'flex-end', zIndex:200, maxWidth:430, margin:'0 auto'}}>
      <div style={{background:G.bg2, borderTop:'1px solid '+G.br, width:'100%', maxHeight:'90vh', overflowY:'auto', padding:20, borderRadius:'10px 10px 0 0'}}>
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:18}}>
          <div style={{...CZ, fontSize:11, letterSpacing:3, color:G.gold}}>{title}</div>
          <button onClick={onClose} style={{background:'none', border:'none', color:G.dim, fontSize:22, cursor:'pointer'}}>âœ•</button>
        </div>
        {children}
      </div>
    </div>
  );
}

// â”€â”€ PHOTOS â”€â”€
function Photos({photos, set}) {
  const ref = useRef();
  const add = async e => {
    const r = await Promise.all(Array.from(e.target.files).map(readImg));
    set(p => [...p, ...r]);
  };
  return (
    <div style={{marginBottom:14}}>
      <Lbl t="ğŸ“· ç…§ç‰‡"/>
      <input ref={ref} type="file" multiple accept="image/*" style={{display:'none'}} onChange={add}/>
      <div onClick={() => ref.current.click()} style={{border:'1px dashed '+G.br, borderRadius:4, padding:photos.length?8:16, cursor:'pointer', background:G.bg4}}>
        {photos.length === 0
          ? <div style={{color:G.dim, fontSize:13, textAlign:'center'}}>é»æ“Šé¸æ“‡ç…§ç‰‡</div>
          : <div style={{display:'flex', gap:6, flexWrap:'wrap'}}>
              {photos.map((ph,i) => (
                <div key={i} style={{position:'relative'}}>
                  <img src={ph.url} alt="" style={{width:70, height:70, objectFit:'cover', borderRadius:2, border:'1px solid '+G.br2}}/>
                  <button onClick={e => {e.stopPropagation(); set(p => p.filter((_,j) => j!==i));}} style={{position:'absolute', top:-5, right:-5, background:G.red, border:'none', borderRadius:'50%', width:16, height:16, cursor:'pointer', color:'#fff', fontSize:9, display:'flex', alignItems:'center', justifyContent:'center', padding:0}}>âœ•</button>
                </div>
              ))}
              <div style={{width:70, height:70, border:'1px dashed '+G.br, borderRadius:2, display:'flex', alignItems:'center', justifyContent:'center', fontSize:20, color:'#4a4030'}}>+</div>
            </div>
        }
      </div>
    </div>
  );
}

// â”€â”€ BAR CHART â”€â”€
function Bar({labels, vals, clr, unit}) {
  const ref = useRef();
  useEffect(() => {
    if (!ref.current || !labels.length) return;
    const ex = Chart.getChart(ref.current); if (ex) ex.destroy();
    new Chart(ref.current, {
      type:'bar',
      data:{labels, datasets:[{data:vals, backgroundColor:clr+'99', borderColor:clr, borderWidth:1, borderRadius:3}]},
      options:{responsive:true, plugins:{legend:{display:false}, tooltip:{callbacks:{label:c => (unit||'') + c.parsed.y.toFixed(0)}}}, scales:{x:{ticks:{color:G.dim, font:{size:10}}, grid:{color:G.br2}}, y:{ticks:{color:G.dim, font:{size:10}, callback:v=>(unit||'')+v}, grid:{color:G.br2}, beginAtZero:true}}}
    });
  }, [labels.join(','), vals.join(',')]);
  if (!labels.length) return <div style={{textAlign:'center', padding:'20px 0', color:'#3a3020', fontSize:12, fontStyle:'italic'}}>æš«ç„¡è³‡æ–™</div>;
  return <canvas ref={ref} style={{maxHeight:200}}/>;
}

// â”€â”€ STARS â”€â”€
function Stars({v, on, labels}) {
  return (
    <div style={{display:'flex', gap:4, alignItems:'center'}}>
      {[1,2,3,4,5].map(s => (
        <button key={s} onClick={() => on && on(s)} style={{background:'none', border:'none', cursor:on?'pointer':'default', fontSize:20, color:s<=v?G.gold:'#3a3020', padding:0}}>â˜…</button>
      ))}
      {labels && v > 0 && <span style={{fontSize:11, color:G.gold, marginLeft:4}}>{labels[v]}</span>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GUIDE TAB â€” structured template
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EMPTY_TMPL = {
  // basic
  city:'', srcType:'å°ç´…æ›¸', url:'', cat:'', status:'æœªè®€', title:'',
  // transport
  nearestAirport:'', howToGet:'', transportTips:'',
  // food
  mustEat:'', discount:'', bestFoodTime:'',
  // sights
  ticketPrice:'', openHours:'', queueTip:'',
  // stay
  stayArea:'', stayNote:'',
  // secret
  myTips:'', specialReminder:'',
  // trust
  trust:0,
  // free
  freeNote:'',
  // meta
  expanded:false,
};

function TmplField({label, value, onChange, multiline, placeholder}) {
  if (multiline) {
    return (
      <div style={{marginBottom:10}}>
        <Lbl t={label}/>
        <textarea
          style={{...S.ta, minHeight:64, fontSize:14}}
          value={value}
          onChange={e => onChange(e.target.value)}
          placeholder={placeholder||''}
        />
      </div>
    );
  }
  return (
    <div style={{marginBottom:10}}>
      <Lbl t={label}/>
      <input style={{...S.inp, fontSize:14}} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder||''}/>
    </div>
  );
}

function TmplSection({icon, title, children}) {
  const [open, setOpen] = useState(true);
  return (
    <div style={{marginBottom:4}}>
      <button onClick={() => setOpen(o=>!o)} style={{width:'100%', background:'transparent', border:'none', cursor:'pointer', padding:'8px 0', display:'flex', alignItems:'center', gap:8}}>
        <span style={{fontSize:13}}>{icon}</span>
        <span style={{...CZ, fontSize:12, letterSpacing:1, color:G.dim}}>{title}</span>
        <HR/>
        <span style={{color:G.dim, fontSize:12}}>{open?'â–²':'â–¼'}</span>
      </button>
      {open && <div style={{paddingLeft:4}}>{children}</div>}
    </div>
  );
}

function GuideTab({T}) {
  const initData = [
    {
      ...EMPTY_TMPL,
      id:1, city:'åŒ—äº¬', srcType:'å°ç´…æ›¸', url:'', cat:'ç¶œåˆ', status:'å·²å»é âœ“', title:'åŒ—äº¬äº”å¤©å››å¤œæ·±åº¦éŠ',
      nearestAirport:'é¦–éƒ½åœ‹éš›æ©Ÿå ´ (PEK) / å¤§èˆˆæ©Ÿå ´ (PKX)',
      howToGet:'æ©Ÿå ´å¿«è»Œç›´é”æ±ç›´é–€ï¼Œç´„30åˆ†é˜ Â¥25',
      transportTips:'åœ°éµè¦†è“‹å»£ï¼ŒApp æ¨è–¦ï¼šåŒ—äº¬åœ°éµå®˜æ–¹App',
      mustEat:'å››å­£æ°‘ç¦çƒ¤é´¨ï¼ˆæ•…å®®æ—ï¼‰ã€è­·åœ‹å¯ºå°åƒã€ç‚’è‚',
      discount:'æ•…å®®é€±äºŒæ—©å ´äººå°‘ï¼Œåšç‰©é¤¨å¤§å¤šå…è²»',
      bestFoodTime:'è­·åœ‹å¯ºæ—©å¸‚ 7-9am',
      ticketPrice:'æ•…å®® Â¥60ï¼Œé•·åŸæ…•ç”°å³ª Â¥45',
      openHours:'æ•…å®® 8:30-17:00ï¼ˆé€±ä¸€é–‰é¤¨ï¼‰',
      queueTip:'æ•…å®®æå‰å®˜ç¶²é ç´„ï¼Œæ—ºå­£æ’éšŠ2å°æ™‚',
      stayArea:'å»ºè­°ä½æ±åŸå€ï¼ˆæ•…å®®/ç‹åºœäº•æ­¥è¡Œå¯é”ï¼‰',
      stayNote:'æ˜¥ç§‹å­£è¨‚æˆ¿è¦æ—©ï¼Œäº”ä¸€/åä¸€äººè¶…å¤š',
      myTips:'æ…•ç”°å³ªé•·åŸæ¯”å…«é”å¶ºå¥½å¤ªå¤šï¼Œæ™¯ç¾äººå°‘',
      specialReminder:'é˜²æ›¬ã€å¸¶ç¾é‡‘å‚™ç”¨ï¼ˆéƒ¨åˆ†å°æ”¤ä¸æ”¶æ”¯ä»˜å¯¶ï¼‰',
      trust:4, freeNote:'', expanded:false,
    },
  ];

  const [srcs, setSrcs] = useStorage('guideSrcs', initData);
  const [cityF, setCityF] = useState('');
  const [catF, setCatF] = useState('');
  const [stF, setStF] = useState('');
  const [showForm, setShowForm] = useState(false);
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState({...EMPTY_TMPL});

  const toggle = id => setSrcs(ss => ss.map(s => s.id===id ? {...s, expanded:!s.expanded} : s));
  const setField = (id, key, val) => setSrcs(ss => ss.map(s => s.id===id ? {...s, [key]:val} : s));

  const openEdit = src => {
    setForm({...src});
    setEditId(src.id);
    setShowForm(true);
  };
  const openNew = () => {
    setForm({...EMPTY_TMPL});
    setEditId(null);
    setShowForm(true);
  };
  const submit = () => {
    if (!form.city) return;
    if (editId) {
      setSrcs(ss => ss.map(s => s.id===editId ? {...form, id:editId, expanded:s.expanded} : s));
    } else {
      setSrcs(ss => [{...form, id:Date.now(), expanded:true}, ...ss]);
    }
    setEditId(null);
    setShowForm(false);
  };

  const filtered = srcs.filter(s =>
    (!cityF || s.city.toLowerCase().includes(cityF.toLowerCase())) &&
    (!catF || s.cat===catF) &&
    (!stF || s.status===stF)
  );
  const cities = [...new Set(filtered.map(s => s.city))];
  const total = srcs.length;

  const hasContent = s => [s.nearestAirport, s.howToGet, s.mustEat, s.ticketPrice, s.stayArea, s.myTips].some(v=>v&&v.trim());

  return (
    <div style={{padding:18}}>
      <div style={{display:'flex', gap:8, marginBottom:14, alignItems:'center'}}>
        <div style={{fontSize:13, color:G.dim, padding:'6px 12px', background:G.bg4, border:'1px solid '+G.br, borderRadius:3}}>
          å…± <span style={{color:G.gold}}>{total}</span> ä»½æ”»ç•¥ Â· å·²å¡«å¯« <span style={{color:G.green}}>{srcs.filter(hasContent).length}</span>
        </div>
        <button style={{...S.gold, padding:'7px 14px', fontSize:11, marginLeft:'auto'}} onClick={openNew}>{T.addSrc}</button>
      </div>

      <div style={{display:'flex', gap:6, marginBottom:14, flexWrap:'wrap'}}>
        <input style={{...S.inp, fontSize:12, flex:1, minWidth:80}} placeholder={T.filterCity} value={cityF} onChange={e=>setCityF(e.target.value)}/>
        <select style={{...S.inp, fontSize:12, appearance:'none', width:'auto', minWidth:90}} value={catF} onChange={e=>setCatF(e.target.value)}>
          <option value="">{T.allCats}</option>
          {GUIDE_CATS.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
        <select style={{...S.inp, fontSize:12, appearance:'none', width:'auto', minWidth:80}} value={stF} onChange={e=>setStF(e.target.value)}>
          <option value="">{T.allStatus}</option>
          {STATUS.map(s => <option key={s} value={s}>{s}</option>)}
        </select>
      </div>

      {cities.length===0 && (
        <div style={{textAlign:'center', padding:'40px 0', color:'#3a3020', fontStyle:'italic', fontSize:13}}>{T.noSources}</div>
      )}

      {cities.map(city => (
        <div key={city} style={{marginBottom:20}}>
          <div style={{...CZ, fontSize:11, letterSpacing:2, color:G.gold, marginBottom:8, display:'flex', alignItems:'center', gap:8}}>
            <span>{city}</span><HR/>
            <span style={{color:G.dim, letterSpacing:1}}>{filtered.filter(s=>s.city===city).length}</span>
          </div>

          {filtered.filter(s => s.city===city).map(s => (
            <div key={s.id} style={{...S.card, padding:0, overflow:'hidden'}}>

              {/* CARD HEADER */}
              <div style={{padding:'12px 14px', cursor:'pointer'}} onClick={() => toggle(s.id)}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-start', gap:8}}>
                  <div style={{flex:1, minWidth:0}}>
                    <div style={{display:'flex', alignItems:'center', gap:5, marginBottom:5, flexWrap:'wrap'}}>
                      {s.srcType && <span style={{fontSize:12, padding:'3px 8px', borderRadius:2, background:(SRC_CLR[s.srcType]||G.dim)+'25', color:SRC_CLR[s.srcType]||G.sub, border:'1px solid '+(SRC_CLR[s.srcType]||G.br)+'44'}}>{s.srcType}</span>}
                      {s.cat && <span style={{fontSize:12, padding:'3px 8px', borderRadius:2, background:(GUIDE_CLR[s.cat]||G.dim)+'20', color:GUIDE_CLR[s.cat]||G.sub, border:'1px solid '+(GUIDE_CLR[s.cat]||G.br)+'44'}}>{s.cat}</span>}
                      <span style={{fontSize:12, padding:'3px 8px', borderRadius:2, color:SCLR[s.status]||G.dim, border:'1px solid '+(SCLR[s.status]||G.br)+'55'}}>{s.status}</span>
                      {s.trust>0 && <span style={{fontSize:12, color:G.gold}}>{'â˜…'.repeat(s.trust)}</span>}
                    </div>
                    <div style={{fontSize:15, fontWeight:500, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{s.title||'ï¼ˆæœªå‘½åï¼‰'}</div>
                    {s.url && <div style={{fontSize:12, color:G.dim, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}}>{s.url}</div>}
                  </div>
                  <div style={{display:'flex', gap:4, flexShrink:0}}>
                    <button onClick={e=>{e.stopPropagation();openEdit(s);}} style={{...S.gh, padding:'5px 9px', fontSize:11}}>{T.edit}</button>
                    <button onClick={e=>{e.stopPropagation();setSrcs(ss=>ss.filter(x=>x.id!==s.id));}} style={{...S.rd, padding:'5px 9px', fontSize:11}}>{T.del}</button>
                  </div>
                </div>
                <div style={{textAlign:'center', color:'#3a3020', fontSize:13, marginTop:3}}>{s.expanded?'â–²':'â–¼'}</div>
              </div>

              {/* EXPANDED TEMPLATE */}
              {s.expanded && (
                <div style={{borderTop:'1px solid '+G.br2, padding:'14px 14px 8px'}}>

                  {/* Status quick change */}
                  <div style={{marginBottom:14}}>
                    <Lbl t={T.status}/>
                    <div style={{display:'flex', gap:6, flexWrap:'wrap'}}>
                      {STATUS.map(st => (
                        <button key={st} onClick={() => setField(s.id,'status',st)} style={chip(s.status===st, SCLR[st])}>{st}</button>
                      ))}
                    </div>
                  </div>

                  {/* Transport */}
                  <TmplSection icon="âœˆï¸" title={T.tTransport}>
                    <TmplField label={T.nearestAirport} value={s.nearestAirport} onChange={v=>setField(s.id,'nearestAirport',v)} placeholder="PEK, CDG, FCO..."/>
                    <TmplField label={T.howToGet} value={s.howToGet} onChange={v=>setField(s.id,'howToGet',v)} multiline placeholder="äº¤é€šæ–¹å¼ã€è²»ç”¨ã€æ™‚é–“..."/>
                    <TmplField label={T.transportTips} value={s.transportTips} onChange={v=>setField(s.id,'transportTips',v)} multiline placeholder="ç•¶åœ°äº¤é€šAppã€æ³¨æ„äº‹é …..."/>
                  </TmplSection>

                  {/* Food */}
                  <TmplSection icon="ğŸœ" title={T.tFood}>
                    <TmplField label={T.mustEat} value={s.mustEat} onChange={v=>setField(s.id,'mustEat',v)} multiline placeholder="å¿…åƒçš„é¤å»³ã€å°åƒã€ç‰¹è‰²æ–™ç†..."/>
                    <TmplField label={T.discount} value={s.discount} onChange={v=>setField(s.id,'discount',v)} placeholder="å­¸ç”Ÿå„ªæƒ ã€AppæŠ˜æ‰£ã€å…è²»æ™‚æ®µ..."/>
                    <TmplField label={T.bestTime} value={s.bestFoodTime} onChange={v=>setField(s.id,'bestFoodTime',v)} placeholder="é¿é–‹å°–å³°æ™‚æ®µå»ºè­°..."/>
                  </TmplSection>

                  {/* Sights */}
                  <TmplSection icon="ğŸ›ï¸" title={T.tSights}>
                    <TmplField label={T.ticketPrice} value={s.ticketPrice} onChange={v=>setField(s.id,'ticketPrice',v)} placeholder="Â¥60 / â‚¬15 / å…è²»..."/>
                    <TmplField label={T.openHours} value={s.openHours} onChange={v=>setField(s.id,'openHours',v)} placeholder="9:00-17:00ï¼Œé€±ä¸€é–‰é¤¨..."/>
                    <TmplField label={T.queueTip} value={s.queueTip} onChange={v=>setField(s.id,'queueTip',v)} multiline placeholder="é ç´„æ–¹å¼ã€æœ€ä½³å…¥å ´æ™‚é–“..."/>
                  </TmplSection>

                  {/* Stay */}
                  <TmplSection icon="ğŸ¨" title={T.tStay}>
                    <TmplField label={T.stayArea} value={s.stayArea} onChange={v=>setField(s.id,'stayArea',v)} placeholder="å»ºè­°ä½çš„å€åŸŸåŠç†ç”±..."/>
                    <TmplField label={T.stayNote} value={s.stayNote} onChange={v=>setField(s.id,'stayNote',v)} multiline placeholder="è¨‚æˆ¿æ³¨æ„ã€æ—ºå­£æé†’..."/>
                  </TmplSection>

                  {/* Secret Tips */}
                  <TmplSection icon="ğŸ’¡" title={T.tSecret}>
                    <TmplField label={T.myTips} value={s.myTips} onChange={v=>setField(s.id,'myTips',v)} multiline placeholder="ç§æˆ¿æ™¯é»ã€ç•¶åœ°äººæ‰çŸ¥é“çš„..."/>
                    <TmplField label={T.specialReminder} value={s.specialReminder} onChange={v=>setField(s.id,'specialReminder',v)} multiline placeholder="ç‰¹åˆ¥æ³¨æ„äº‹é …ã€è¸©é›·é é˜²..."/>
                  </TmplSection>

                  {/* Trust + Free note */}
                  <TmplSection icon="â­" title={T.tTrust}>
                    <div style={{marginBottom:10}}>
                      <Lbl t={T.trustScore}/>
                      <Stars v={s.trust} on={v=>setField(s.id,'trust',v)} labels={STAR_LABELS}/>
                    </div>
                    <TmplField label={T.freeNote} value={s.freeNote} onChange={v=>setField(s.id,'freeNote',v)} multiline placeholder="å…¶ä»–æƒ³è¨˜éŒ„çš„..."/>
                  </TmplSection>

                  {s.url && (
                    <div style={{marginTop:8, marginBottom:8}}>
                      <a href={s.url} target="_blank" rel="noopener noreferrer" style={{fontSize:12, color:G.gold, textDecoration:'none', borderBottom:'1px solid rgba(212,168,83,.3)'}}>
                        ğŸ”— {T.url.replace('ï¼ˆé¸å¡«ï¼‰','').replace(' (optional)','')} â†’ {s.url}
                      </a>
                    </div>
                  )}
                </div>
              )}
            </div>
          ))}
        </div>
      ))}

      {/* ADD / EDIT FORM */}
      <Modal show={showForm} onClose={() => setShowForm(false)} title={editId ? T.edit : T.addSrc}>
        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:8, marginBottom:10}}>
          <div><Lbl t={T.city}/><input style={S.inp} placeholder="åŒ—äº¬, Roma..." value={form.city} onChange={e=>setForm(p=>({...p,city:e.target.value}))}/></div>
          <div>
            <Lbl t={T.category}/>
            <select style={{...S.inp, appearance:'none'}} value={form.cat} onChange={e=>setForm(p=>({...p,cat:e.target.value}))}>
              <option value="">é¸æ“‡</option>
              {GUIDE_CATS.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
        </div>
        <div style={{marginBottom:10}}><Lbl t={T.srcTitle}/><input style={S.inp} placeholder="å¦‚ï¼šåŒ—äº¬äº”å¤©å››å¤œæ·±åº¦éŠ..." value={form.title} onChange={e=>setForm(p=>({...p,title:e.target.value}))}/></div>
        <div style={{marginBottom:10}}>
          <Lbl t={T.srcType}/>
          <div style={{display:'flex', flexWrap:'wrap', gap:6}}>
            {SRC_TYPES.map(t => <button key={t} onClick={() => setForm(p=>({...p,srcType:t}))} style={chip(form.srcType===t, SRC_CLR[t])}>{t}</button>)}
          </div>
        </div>
        <div style={{marginBottom:10}}><Lbl t={T.url}/><input style={S.inp} placeholder="https://..." value={form.url} onChange={e=>setForm(p=>({...p,url:e.target.value}))}/></div>
        <div style={{marginBottom:14}}>
          <Lbl t={T.status}/>
          <div style={{display:'flex', gap:6, flexWrap:'wrap'}}>
            {STATUS.map(st => <button key={st} onClick={() => setForm(p=>({...p,status:st}))} style={chip(form.status===st, SCLR[st])}>{st}</button>)}
          </div>
        </div>
        <div style={{display:'flex', gap:10}}>
          <button style={{...S.gh, flex:1}} onClick={() => setShowForm(false)}>{T.cancel}</button>
          <button style={{...S.gold, flex:2}} onClick={submit}>{T.save}</button>
        </div>
      </Modal>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FX PANEL â€” any-pair rate editing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function FXPanel({T}) {
  // Store rates as a matrix: rates[A][B] = how many B per 1 A
  // We derive this from BASE_FX: rate(A->B) = BASE_FX[A] / BASE_FX[B]
  // User can override any pair directly
  const [overrides, setOverrides] = useState({});  // { 'CNY Â¥->EUR â‚¬': 0.128, ... }
  const [fc, setFc] = useState('CNY Â¥');
  const [tc, setTc] = useState('EUR â‚¬');
  const [amt, setAmt] = useState('100');
  // pair edit state
  const [pA, setPA] = useState('EUR â‚¬');
  const [pB, setPB] = useState('CNY Â¥');
  const [pVal, setPVal] = useState('');
  const sym = c => c.split(' ')[1] || '';

  const getRate = (from, to) => {
    if (from === to) return 1;
    const key = from + '->' + to;
    const rkey = to + '->' + from;
    if (overrides[key] !== undefined) return overrides[key];
    if (overrides[rkey] !== undefined) return 1 / overrides[rkey];
    return BASE_FX[from] / BASE_FX[to];
  };

  const setPair = () => {
    const n = parseFloat(pVal);
    if (isNaN(n) || n <= 0) return;
    const key = pA + '->' + pB;
    setOverrides(o => ({...o, [key]: n}));
    setPVal('');
  };

  const resetAll = () => setOverrides({});

  const result = (parseFloat(amt)||0) * getRate(fc, tc);

  // Build rate preview table
  const pairs = [];
  for (let i = 0; i < CURR.length; i++) {
    for (let j = i+1; j < CURR.length; j++) {
      pairs.push([CURR[i], CURR[j]]);
    }
  }

  return (
    <div>
      {/* Quick converter */}
      <div style={{...S.card, marginBottom:14}}>
        <div style={{...CZ, fontSize:11, letterSpacing:2, color:G.dim, marginBottom:12}}>{T.calcTitle}</div>
        <div style={{display:'grid', gridTemplateColumns:'1fr auto 1fr', gap:8, alignItems:'center', marginBottom:12}}>
          <div>
            <Lbl t={T.fxFrom}/>
            <select style={{...S.inp, appearance:'none', fontSize:13}} value={fc} onChange={e=>setFc(e.target.value)}>
              {CURR.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div style={{color:G.gold, fontSize:18, marginTop:16, textAlign:'center'}}>â‡„</div>
          <div>
            <Lbl t={T.fxTo}/>
            <select style={{...S.inp, appearance:'none', fontSize:13}} value={tc} onChange={e=>setTc(e.target.value)}>
              {CURR.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
        </div>
        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:8, alignItems:'flex-end'}}>
          <div><Lbl t={T.fxAmt}/><input style={{...S.inp, fontSize:16}} type="number" value={amt} onChange={e=>setAmt(e.target.value)} placeholder="100"/></div>
          <div>
            <div style={{fontSize:28, fontWeight:300, color:G.gold}}>{sym(tc)}{result.toFixed(2)}</div>
            <div style={{fontSize:12, color:G.dim}}>{tc.split(' ')[0]}</div>
          </div>
        </div>
        <div style={{marginTop:8, fontSize:13, color:G.dim}}>1 {sym(fc)} = {sym(tc)}{getRate(fc,tc).toFixed(4)}{Object.keys(overrides).length > 0 && <span style={{color:G.gold, marginLeft:6}}>â— å·²è‡ªè¨‚</span>}</div>
      </div>

      {/* Pair editor */}
      <div style={{...S.card, marginBottom:14}}>
        <div style={{...CZ, fontSize:11, letterSpacing:2, color:G.dim, marginBottom:12}}>{T.pairEdit}</div>
        <div style={{display:'grid', gridTemplateColumns:'1fr auto 1fr', gap:8, alignItems:'flex-end', marginBottom:10}}>
          <div>
            <Lbl t={T.pairFrom}/>
            <select style={{...S.inp, appearance:'none', fontSize:13}} value={pA} onChange={e=>setPA(e.target.value)}>
              {CURR.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div style={{color:G.dim, fontSize:14, marginBottom:12, textAlign:'center'}}>â†’</div>
          <div>
            <Lbl t={T.pairTo}/>
            <select style={{...S.inp, appearance:'none', fontSize:13}} value={pB} onChange={e=>setPB(e.target.value)}>
              {CURR.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
        </div>
        <div style={{display:'flex', gap:8, alignItems:'flex-end', marginBottom:10}}>
          <div style={{flex:1}}>
            <Lbl t={'1 ' + sym(pA) + ' = ? ' + sym(pB)}/>
            <input style={{...S.inp, fontSize:15}} type="number" placeholder={getRate(pA,pB).toFixed(4)} value={pVal} onChange={e=>setPVal(e.target.value)} onKeyDown={e=>e.key==='Enter'&&setPair()}/>
          </div>
          <button style={{...S.gold, padding:'10px 16px', flexShrink:0}} onClick={setPair}>{T.setPair}</button>
        </div>
        <div style={{fontSize:13, color:G.dim, marginBottom:pA!==pB?8:0}}>
          {pA!==pB && 'ç›®å‰: 1 ' + sym(pA) + ' = ' + sym(pB) + getRate(pA,pB).toFixed(4)}
        </div>
      </div>

      {/* Rate table */}
      <div style={{marginBottom:10}}>
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:10}}>
          <div style={{...CZ, fontSize:11, letterSpacing:2, color:G.dim}}>æ‰€æœ‰åŒ¯ç‡</div>
          {Object.keys(overrides).length > 0 && (
            <button style={{...S.gh, fontSize:11, padding:'5px 9px'}} onClick={resetAll}>{T.resetFx}</button>
          )}
        </div>
        {pairs.map(([a,b]) => {
          const key = a+'->'+b;
          const rkey = b+'->'+a;
          const isCustom = overrides[key] !== undefined || overrides[rkey] !== undefined;
          return (
            <div key={key} style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'8px 10px', borderBottom:'1px solid '+G.br2, fontSize:13}}>
              <span style={{color:G.sub}}>{sym(a)} â†’ {sym(b)}</span>
              <span style={{color:isCustom?G.gold:G.sub, fontSize:12}}>
                {isCustom && <span style={{fontSize:9, marginRight:4}}>â—</span>}
                1 {sym(a)} = {sym(b)}{getRate(a,b).toFixed(4)}
              </span>
            </div>
          );
        })}
      </div>

      <div style={{padding:'10px 12px', background:'rgba(212,168,83,.04)', border:'1px solid '+G.br, borderRadius:4, fontSize:13, color:G.dim, lineHeight:1.6}}>
        {T.fxNote}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS TAB â€” preferences only
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SettingsTab({T, lang, setLang, defCurr, setDefCurr, tripName, setTripName}) {
  return (
    <div style={{padding:18}}>
      <div style={{...CZ, fontSize:11, letterSpacing:3, color:G.dim, marginBottom:20}}>âš™ {T.settingsTitle.toUpperCase()}</div>

      <div style={{...S.card, marginBottom:14}}>
        <div style={{...CZ, fontSize:12, letterSpacing:2, color:G.gold, marginBottom:14}}>âœ¦ åå¥½</div>

        <div style={{marginBottom:14}}>
          <Lbl t={T.defLang}/>
          <div style={{display:'flex', gap:6, flexWrap:'wrap'}}>
            {['ç¹ä¸­','ç®€ä¸­','EN','IT'].map(l => (
              <button key={l} onClick={() => setLang(l)} style={chip(lang===l)}>{l}</button>
            ))}
          </div>
        </div>

        <div style={{marginBottom:14}}>
          <Lbl t={T.defCurrency}/>
          <div style={{display:'flex', gap:6, flexWrap:'wrap'}}>
            {CURR.map(c => (
              <button key={c} onClick={() => setDefCurr(c)} style={chip(defCurr===c)}>{c}</button>
            ))}
          </div>
        </div>

        <div style={{marginBottom:4}}>
          <Lbl t={T.tripName}/>
          <input style={S.inp} placeholder="2025 æ­æ´²ä¹‹æ—…ã€åŒ—äº¬å‡ºå·®..." value={tripName} onChange={e=>setTripName(e.target.value)}/>
        </div>
      </div>

      <div style={{padding:'14px', background:'rgba(212,168,83,.04)', border:'1px solid '+G.br, borderRadius:4, fontSize:13, color:G.dim, lineHeight:1.9}}>
        âœ¦ VIAGGIO v2.0<br/>
        ğŸ“± {T.appInfo1}<br/>
        ğŸ“¤ {T.appInfo2}<br/>
        ğŸ—º {T.appInfo3}<br/>
        <span style={{color:G.dim, fontSize:11}}>{T.themeNote}</span>
      </div>

      <div style={{marginTop:14}}>
        <button
          style={{...S.rd, width:'100%', fontSize:12, padding:'11px'}}
          onClick={() => {
            if (window.confirm(T.clearConfirm)) {
              ['commutes','entries','exps','lang','defCurr','tripName','guideSrcs'].forEach(k => {
                try { localStorage.removeItem('vg_' + k); } catch(e) {}
              });
              window.location.reload();
            }
          }}
        >
          {T.clearData}
        </button>
      </div>
    </div>
  );
}

// â”€â”€ LOCAL STORAGE PERSISTENCE â”€â”€
function trySave(key, val) {
  try {
    localStorage.setItem('vg_' + key, JSON.stringify(val));
  } catch(e) {
    try {
      const safe = Array.isArray(val)
        ? val.map(item => item && typeof item === 'object' && 'photos' in item ? {...item, photos:[]} : item)
        : val;
      localStorage.setItem('vg_' + key, JSON.stringify(safe));
      localStorage.setItem('vg_photoWarn', '1');
    } catch(e2) {}
  }
}

function useStorage(key, init) {
  const [val, setVal] = useState(() => {
    try {
      const stored = localStorage.getItem('vg_' + key);
      return stored ? JSON.parse(stored) : init;
    } catch(e) { return init; }
  });
  const set = v => { setVal(v); trySave(key, v); };
  const setFn = fn => {
    setVal(prev => {
      const next = fn(prev);
      trySave(key, next);
      return next;
    });
  };
  return [val, (v) => typeof v === 'function' ? setFn(v) : set(v)];
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App() {
  const [lang, setLang] = useStorage('lang', 'ç¹ä¸­');
  const T = TR[lang];
  const [tab, setTab] = useState(0);
  const [defCurr, setDefCurr] = useStorage('defCurr', 'CNY Â¥');
  const [tripName, setTripName] = useStorage('tripName', '');

  // Transport
  const [from, setFrom] = useState('');
  const [to, setTo] = useState('');
  const [searched, setSearched] = useState(false);
  const [commutes, setCommutes] = useStorage('commutes', [
    {id:1, date:'2025-04-10', from:'åŒ—äº¬', to:'ä¸Šæµ·', estTime:'4å°æ™‚18åˆ†', cost:553, currency:'CNY Â¥', note:'é«˜éµ G1æ¬¡'},
    {id:2, date:'2025-09-03', from:'Paris', to:'Roma', estTime:'6å°æ™‚50åˆ†', cost:89, currency:'EUR â‚¬', note:'TGV Lyria'},
  ]);
  const [showST, setShowST] = useState(false);
  const [editCId, setEditCId] = useState(null);
  const [stF, setStF] = useState({date:'', estTime:'', cost:'', currency:'CNY Â¥', note:''});

  // Diary
  const [entries, setEntries] = useStorage('entries', [
    {id:1, city:'åŒ—äº¬', country:'ä¸­å›½', date:'2025-04-10', rating:5, comment:'æ•…å®®æ¸…æ™¨çš„å…‰ç·šçµ•ç¾ï¼Œæ—©èµ·çµ•å°å€¼å¾—ï¼', photos:[], tags:'æ•…å®®,æ­·å²,å¿…å»'},
    {id:2, city:'Roma', country:'æ„å¤§åˆ©', date:'2025-09-03', rating:5, comment:'Trastevere di notte â€” perfetto.', photos:[], tags:'Roma,notte,gelato'},
  ]);
  const [showDF, setShowDF] = useState(false);
  const [editDId, setEditDId] = useState(null);
  const [dF, setDF] = useState({city:'', country:'', date:'', rating:5, comment:'', tags:''});
  const [dPh, setDPh] = useState([]);

  // Expenses
  const [exps, setExps] = useStorage('exps', [
    {id:1, date:'2025-04-10', city:'åŒ—äº¬', shop:'å…¨èšå¾·', category:'é¤é£²', amount:288, currency:'CNY Â¥', note:'çƒ¤é´¨', photos:[]},
    {id:2, date:'2025-04-11', city:'åŒ—äº¬', shop:'æ•…å®®', category:'æ™¯é»é–€ç¥¨', amount:60, currency:'CNY Â¥', note:'', photos:[]},
    {id:3, date:'2025-09-03', city:'Roma', shop:'B&B Trastevere', category:'ä½å®¿', amount:95, currency:'EUR â‚¬', note:'2æ™š', photos:[]},
    {id:4, date:'2025-09-04', city:'Roma', shop:'Roscioli', category:'é¤é£²', amount:38, currency:'EUR â‚¬', note:'åˆé¤', photos:[]},
  ]);
  const [showEF, setShowEF] = useState(false);
  const [editEId, setEditEId] = useState(null);
  const [eF, setEF] = useState({date:'', city:'', shop:'', category:'', amount:'', currency:'CNY Â¥', note:''});
  const [ePh, setEPh] = useState([]);

  // Stats
  const [sCurr, setSCurr] = useState(defCurr);
  const [sView, setSView] = useState('monthly');
  const [showCDD, setShowCDD] = useState(false);

  useEffect(() => { setSCurr(defCurr); }, [defCurr]);

  const sym = c => c.split(' ')[1] || '';
  const cv = (e, fx) => {
    const r = fx ? fx[e.currency] / fx[sCurr] : BASE_FX[e.currency] / BASE_FX[sCurr];
    return (parseFloat(e.amount)||0) * r;
  };
  const total = exps.reduce((a,e) => a + cv(e, null), 0);
  const byM = exps.reduce((a,e) => { const m=e.date&&e.date.slice(0,7)||'?'; a[m]=(a[m]||0)+cv(e,null); return a; }, {});
  const byC = exps.reduce((a,e) => { a[e.city]=(a[e.city]||0)+cv(e,null); return a; }, {});
  const mL = Object.keys(byM).sort();
  const cL = Object.keys(byC).sort((a,b)=>byC[b]-byC[a]);

  const doSearch = () => {
    if (!from.trim() || !to.trim()) return;
    window.open('https://www.google.com/maps/dir/?api=1&origin=' + encodeURIComponent(from) + '&destination=' + encodeURIComponent(to) + '&travelmode=transit', '_blank');
    setSearched(true);
    setStF(f => ({...f, date:new Date().toISOString().slice(0,10)}));
  };

  const saveCommute = () => {
    if (!stF.date) return;
    if (editCId) {
      setCommutes(cs => cs.map(c => c.id===editCId ? {...c, ...stF, cost:parseFloat(stF.cost)||0} : c));
      setEditCId(null);
    } else {
      setCommutes(cs => [{id:Date.now(), from:from.trim(), to:to.trim(), ...stF, cost:parseFloat(stF.cost)||0}, ...cs]);
      setSearched(false);
    }
    setShowST(false);
    setStF({date:'', estTime:'', cost:'', currency:'CNY Â¥', note:''});
  };

  const openEditD = e => { setDF({city:e.city, country:e.country, date:e.date, rating:e.rating, comment:e.comment, tags:e.tags}); setDPh(e.photos||[]); setEditDId(e.id); setShowDF(true); };
  const submitD = () => {
    if (!dF.city || !dF.date) return;
    if (editDId) setEntries(es => es.map(e => e.id===editDId ? {...e, ...dF, photos:dPh} : e));
    else setEntries(es => [{id:Date.now(), ...dF, photos:dPh}, ...es]);
    setDF({city:'', country:'', date:'', rating:5, comment:'', tags:''}); setDPh([]); setEditDId(null); setShowDF(false);
  };

  const openEditE = e => { setEF({date:e.date, city:e.city, shop:e.shop||'', category:e.category, amount:e.amount, currency:e.currency, note:e.note||''}); setEPh(e.photos||[]); setEditEId(e.id); setShowEF(true); };
  const submitE = () => {
    if (!eF.amount || !eF.date) return;
    const item = {...eF, amount:parseFloat(eF.amount)||0, photos:ePh};
    if (editEId) setExps(es => es.map(e => e.id===editEId ? {...e, ...item} : e));
    else setExps(es => [{id:Date.now(), ...item}, ...es]);
    setEF({date:'', city:'', shop:'', category:'', amount:'', currency:'CNY Â¥', note:''}); setEPh([]); setEditEId(null); setShowEF(false);
  };

  const ICONS = ['ğŸš„','ğŸ—º','ğŸ“”','ğŸ’°','ğŸ“Š','âš™'];

  return (
    <div style={{fontFamily:"'Cormorant Garamond','Georgia',serif", background:G.bg, minHeight:'100vh', color:G.text, maxWidth:430, margin:'0 auto'}}>

      {/* HEADER */}
      <div style={{padding:'16px 20px 12px', borderBottom:'1px solid '+G.br}}>
        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
          <div>
            <div style={{...CZ, fontSize:11, letterSpacing:4, color:G.dim}}>VIAGGIO Â· è¡Œ</div>
            <div style={{fontSize:20, fontWeight:300, fontStyle:'italic', letterSpacing:2, marginTop:2}}>
              {tripName || 'æ—…é€”æ”»ç•¥'}
            </div>
          </div>
          <div style={{display:'flex', flexDirection:'column', alignItems:'flex-end', gap:6}}>
            <div style={{display:'flex', gap:3}}>
              {['ç¹ä¸­','ç®€ä¸­','EN','IT'].map(l => (
                <button key={l} onClick={() => setLang(l)} style={l===lang ? {...S.gold, padding:'5px 9px', fontSize:11} : {...S.gh, padding:'4px 8px', fontSize:9}}>{l}</button>
              ))}
            </div>
            <button style={{...S.out, fontSize:11, padding:'5px 11px'}} onClick={() => csvDl(exps.map(e=>({Date:e.date,City:e.city,Shop:e.shop,Cat:e.category,Amt:e.amount,Cur:e.currency,Note:e.note})), 'expenses.csv')}>â†“ CSV</button>
          </div>
        </div>
      </div>

      {/* TAB BAR */}
      <div style={{display:'flex', borderBottom:'1px solid '+G.br, background:G.bg, position:'sticky', top:0, zIndex:10}}>
        {ICONS.map((ic,i) => (
          <button key={i} onClick={() => setTab(i)} style={{flex:1, background:'transparent', border:'none', cursor:'pointer', padding:'7px 0', ...CZ, fontSize:11, letterSpacing:0, color:tab===i?G.gold:G.dim, position:'relative'}}>
            <span style={{fontSize:16, display:'block', marginBottom:2}}>{ic}</span>
            {T.tabs[i]}
            {tab===i && <span style={{position:'absolute', bottom:0, left:'15%', right:'15%', height:1, background:G.gold, display:'block'}}/>}
          </button>
        ))}
      </div>

      <div style={{overflowY:'auto', height:'calc(100vh - 132px)', paddingBottom:24}}>
        {localStorage.getItem('vg_photoWarn') === '1' && (
          <div style={{background:'rgba(155,106,106,.12)', border:'1px solid rgba(155,106,106,.3)', padding:'8px 14px', fontSize:13, color:'#c8948a', lineHeight:1.6, display:'flex', justifyContent:'space-between', alignItems:'center'}}>
            <span>âš  å„²å­˜ç©ºé–“ä¸è¶³ï¼Œéƒ¨åˆ†ç…§ç‰‡æœªèƒ½ä¿ç•™ï¼ˆæ–‡å­—è³‡æ–™å‡å·²å„²å­˜ï¼‰</span>
            <button onClick={() => { localStorage.removeItem('vg_photoWarn'); window.location.reload(); }} style={{background:'none', border:'none', color:'#c8948a', cursor:'pointer', fontSize:14}}>âœ•</button>
          </div>
        )}

        {/* TRANSPORT */}
        {tab===0 && (
          <div style={{padding:18}}>
            <div style={{background:'rgba(122,155,106,.08)', border:'1px solid rgba(122,155,106,.2)', borderRadius:4, padding:'10px 12px', marginBottom:14, fontSize:11, color:G.green, lineHeight:1.6}}>
              {T.mapsInfo}
            </div>
            <SecHead t={T.transport}/>
            <div style={{marginBottom:10}}><Lbl t={T.from}/><input style={S.inp} placeholder="Beijing China, åŒ—äº¬..." value={from} onChange={e=>setFrom(e.target.value)} onKeyDown={e=>e.key==='Enter'&&doSearch()}/></div>
            <div style={{display:'flex', alignItems:'center', margin:'8px 0'}}>
              <div style={{flex:1, height:1, background:G.br}}/>
              <div style={{margin:'0 14px', color:G.gold, fontSize:18}}>â†•</div>
              <div style={{flex:1, height:1, background:G.br}}/>
            </div>
            <div style={{marginBottom:12}}><Lbl t={T.to}/><input style={S.inp} placeholder="Shanghai China, Roma..." value={to} onChange={e=>setTo(e.target.value)} onKeyDown={e=>e.key==='Enter'&&doSearch()}/></div>
            <button style={{...S.gold, width:'100%', fontSize:11, padding:12, letterSpacing:3}} onClick={doSearch}>ğŸ—º {T.openMaps}</button>

            {searched && (
              <div style={{marginTop:14}}>
                <div style={{...S.card, fontSize:12, color:G.sub, lineHeight:1.7, marginBottom:8}}>{T.saveResult}</div>
                <button style={{...S.out, width:'100%', fontSize:12}} onClick={() => setShowST(true)}>{T.saveLog}</button>
              </div>
            )}

            {commutes.length > 0 && (
              <div style={{marginTop:20}}>
                <SecHead t={T.tripLog}/>
                {commutes.map(c => (
                  <div key={c.id} style={{...S.card, display:'flex', justifyContent:'space-between', alignItems:'flex-start'}}>
                    <div style={{flex:1}}>
                      <div style={{fontSize:15, fontWeight:500, marginBottom:3}}>{c.from} â†’ {c.to}</div>
                      <div style={{fontSize:12, color:G.dim, marginBottom:4}}>{c.date}</div>
                      <div style={{display:'flex', gap:12, flexWrap:'wrap'}}>
                        {c.estTime && <div><span style={{fontSize:11, color:G.dim}}>{T.estTime} </span><span style={{fontSize:12}}>{c.estTime}</span></div>}
                        {c.cost>0 && <div><span style={{fontSize:11, color:G.dim}}>{T.cost} </span><span style={{fontSize:12, color:G.gold}}>{c.currency&&c.currency.split(' ')[1]}{c.cost}</span></div>}
                      </div>
                      {c.note && <div style={{fontSize:11, color:G.sub, fontStyle:'italic', marginTop:3}}>{c.note}</div>}
                    </div>
                    <div style={{display:'flex', gap:5, marginLeft:8, flexShrink:0}}>
                      <button onClick={() => {
                        setStF({date:c.date, estTime:c.estTime||'', cost:c.cost||'', currency:c.currency||'CNY Â¥', note:c.note||''});
                        setEditCId(c.id);
                        setShowST(true);
                      }} style={{...S.gh, padding:'5px 9px', fontSize:11}}>{T.edit}</button>
                      <button onClick={() => setCommutes(cs => cs.filter(x => x.id!==c.id))} style={{...S.rd, padding:'5px 9px', fontSize:11}}>{T.del}</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* GUIDE */}
        {tab===1 && <GuideTab T={T}/>}

        {/* DIARY */}
        {tab===2 && (
          <div style={{padding:18}}>
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:14}}>
              <div style={{fontSize:17, fontStyle:'italic'}}>{T.diaryTitle}</div>
              <div style={{display:'flex', gap:8}}>
                <button style={{...S.gh, fontSize:11}} onClick={() => csvDl(entries.map(e=>({City:e.city,Country:e.country,Date:e.date,Rating:e.rating,Comment:e.comment,Tags:e.tags})), 'diary.csv')}>â†“ CSV</button>
                <button style={S.gold} onClick={() => { setDF({city:'', country:'', date:'', rating:5, comment:'', tags:''}); setDPh([]); setEditDId(null); setShowDF(true); }}>{T.addDiary}</button>
              </div>
            </div>
            {entries.map(e => (
              <div key={e.id} style={S.card}>
                {e.photos && e.photos.length > 0 && (
                  <div style={{marginBottom:10}}>
                    {e.photos.length===1
                      ? <img src={e.photos[0].url} alt="" style={{width:'100%', maxHeight:220, objectFit:'cover', borderRadius:3, border:'1px solid '+G.br2, display:'block'}}/>
                      : <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:4}}>{e.photos.map((ph,j) => <img key={j} src={ph.url} alt="" style={{width:'100%', height:100, objectFit:'cover', borderRadius:2, border:'1px solid '+G.br2}}/>)}</div>
                    }
                  </div>
                )}
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-start', marginBottom:6}}>
                  <div>
                    <div style={{fontSize:16, fontWeight:500}}>{e.city}</div>
                    <div style={{fontSize:12, color:G.dim}}>{e.country} Â· {e.date}</div>
                  </div>
                  <div style={{display:'flex', gap:5, alignItems:'center'}}>
                    <Stars v={e.rating}/>
                    <button onClick={() => openEditD(e)} style={{...S.gh, padding:'5px 9px', fontSize:11}}>{T.edit}</button>
                    <button onClick={() => setEntries(es => es.filter(x => x.id!==e.id))} style={{...S.rd, padding:'5px 9px', fontSize:11}}>{T.del}</button>
                  </div>
                </div>
                {e.comment && <div style={{fontSize:13, color:G.sub, lineHeight:1.7, fontStyle:'italic', marginBottom:8}}>"{e.comment}"</div>}
                {e.tags && <div style={{display:'flex', gap:5, flexWrap:'wrap'}}>{e.tags.split(',').filter(Boolean).map((tg,j) => <span key={j} style={{fontSize:12, padding:'4px 8px', borderRadius:2, background:'rgba(212,168,83,.08)', color:G.gold, border:'1px solid rgba(212,168,83,.2)'}}>{tg.trim()}</span>)}</div>}
              </div>
            ))}
          </div>
        )}

        {/* EXPENSES */}
        {tab===3 && (
          <div style={{padding:18}}>
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:14}}>
              <div style={{fontSize:17, fontStyle:'italic'}}>{T.expTitle}</div>
              <div style={{display:'flex', gap:8}}>
                <button style={{...S.gh, fontSize:11}} onClick={() => csvDl(exps.map(e=>({Date:e.date,City:e.city,Shop:e.shop,Cat:e.category,Amt:e.amount,Cur:e.currency,Note:e.note})), 'expenses.csv')}>â†“ CSV</button>
                <button style={S.gold} onClick={() => { setEF({date:'', city:'', shop:'', category:'', amount:'', currency:defCurr, note:''}); setEPh([]); setEditEId(null); setShowEF(true); }}>{T.addExp}</button>
              </div>
            </div>
            {exps.map(e => (
              <div key={e.id} style={S.card}>
                {e.photos && e.photos.length > 0 && (
                  <div style={{display:'flex', gap:4, flexWrap:'wrap', marginBottom:8}}>
                    {e.photos.map((ph,j) => <img key={j} src={ph.url} alt="" style={{width:60, height:60, objectFit:'cover', borderRadius:2, border:'1px solid '+G.br2}}/>)}
                  </div>
                )}
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-start'}}>
                  <div style={{flex:1}}>
                    <div style={{display:'flex', alignItems:'center', gap:6, marginBottom:4, flexWrap:'wrap'}}>
                      {e.category && <span style={{fontSize:12, padding:'3px 8px', borderRadius:2, background:(EXP_CLR[e.category]||G.dim)+'20', color:EXP_CLR[e.category]||G.sub, border:'1px solid '+(EXP_CLR[e.category]||G.br)+'33'}}>{e.category}</span>}
                      {e.shop && <span style={{fontSize:14, fontWeight:500}}>{e.shop}</span>}
                    </div>
                    <div style={{fontSize:12, color:G.dim, marginBottom:3}}>{e.city} Â· {e.date}</div>
                    {e.note && <div style={{fontSize:12, color:G.sub, fontStyle:'italic'}}>{e.note}</div>}
                  </div>
                  <div style={{textAlign:'right', marginLeft:12}}>
                    <div style={{fontSize:20, fontWeight:300, color:G.gold}}>{e.currency&&e.currency.split(' ')[1]}{e.amount}</div>
                    <div style={{fontSize:12, color:G.dim, marginBottom:4}}>{e.currency&&e.currency.split(' ')[0]}</div>
                    <div style={{display:'flex', gap:4}}>
                      <button onClick={() => openEditE(e)} style={{...S.gh, padding:'5px 9px', fontSize:11}}>{T.edit}</button>
                      <button onClick={() => setExps(es => es.filter(x => x.id!==e.id))} style={{...S.rd, padding:'5px 9px', fontSize:11}}>{T.del}</button>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* STATS */}
        {tab===4 && (
          <div style={{padding:18}}>
            <div style={{background:G.bg4, border:'1px solid '+G.br, borderRadius:6, padding:14, marginBottom:14}}>
              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:10}}>
                <div style={{...CZ, fontSize:11, letterSpacing:2, color:G.dim}}>{T.yearTotal}</div>
                <div style={{position:'relative'}}>
                  <button onClick={() => setShowCDD(v=>!v)} style={{...S.gh, fontSize:12, padding:'6px 10px', display:'flex', alignItems:'center', gap:4}}>
                    {sCurr}<span style={{color:G.gold}}>â–¾</span>
                  </button>
                  {showCDD && (
                    <div style={{position:'absolute', right:0, top:'100%', background:G.bg2, border:'1px solid '+G.br, borderRadius:2, zIndex:50, minWidth:110}}>
                      {CURR.map(c => (
                        <div key={c} style={{padding:'7px 12px', cursor:'pointer', fontSize:13, color:c===sCurr?G.gold:G.sub}} onMouseEnter={e=>e.currentTarget.style.background=G.bg3} onMouseLeave={e=>e.currentTarget.style.background='transparent'} onClick={() => {setSCurr(c); setShowCDD(false);}}>
                          {c}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
              <div style={{fontSize:36, fontWeight:300}}>
                <span style={{fontSize:22, color:G.gold}}>{sym(sCurr)}</span>{total.toFixed(0)}
                <span style={{fontSize:12, color:G.dim, marginLeft:8}}>{sCurr.split(' ')[0]}</span>
              </div>
            </div>

            <div style={{display:'flex', gap:5, marginBottom:16, flexWrap:'wrap'}}>
              {[['monthly',T.monthly],['city',T.byCity],['fx',T.fx],['commute',T.commute]].map(([v,l]) => (
                <button key={v} style={chip(sView===v)} onClick={() => setSView(v)}>{l}</button>
              ))}
            </div>

            {sView==='monthly' && (
              <div>
                <SecHead t={T.monthly}/>
                <Bar labels={mL} vals={mL.map(m=>byM[m])} clr={G.gold} unit={sym(sCurr)}/>
                <div style={{marginTop:12}}>{mL.map(m => (
                  <div key={m} style={{display:'flex', justifyContent:'space-between', padding:'8px 0', borderBottom:'1px solid '+G.br2, fontSize:13}}>
                    <span style={{color:G.sub}}>{m}</span><span style={{color:G.gold}}>{sym(sCurr)}{byM[m].toFixed(0)}</span>
                  </div>
                ))}</div>
              </div>
            )}
            {sView==='city' && (
              <div>
                <SecHead t={T.byCity}/>
                <Bar labels={cL} vals={cL.map(c=>byC[c])} clr={G.green} unit={sym(sCurr)}/>
                <div style={{marginTop:12}}>{cL.map(c => (
                  <div key={c} style={{display:'flex', justifyContent:'space-between', padding:'8px 0', borderBottom:'1px solid '+G.br2, fontSize:13}}>
                    <span style={{color:G.sub}}>{c}</span><span style={{color:G.green}}>{sym(sCurr)}{byC[c].toFixed(0)}</span>
                  </div>
                ))}</div>
              </div>
            )}
            {sView==='fx' && <FXPanel T={T}/>}
            {sView==='commute' && (
              <div>
                <SecHead t={T.commute}/>
                {commutes.length===0 && <div style={{textAlign:'center', padding:'28px 0', color:'#3a3020', fontStyle:'italic', fontSize:13}}>æš«ç„¡è¨˜éŒ„</div>}
                {commutes.map(c => (
                  <div key={c.id} style={S.card}>
                    <div style={{fontSize:15, fontWeight:500, marginBottom:3}}>{c.from} â†’ {c.to}</div>
                    <div style={{fontSize:12, color:G.dim, marginBottom:5}}>{c.date}</div>
                    <div style={{display:'flex', gap:14, flexWrap:'wrap'}}>
                      {c.estTime && <div><span style={{fontSize:11, color:G.dim}}>{T.estTime} </span><span style={{fontSize:13, color:G.gold}}>{c.estTime}</span></div>}
                      {c.cost>0 && <div><span style={{fontSize:11, color:G.dim}}>{T.cost} </span><span style={{fontSize:13, color:G.green}}>{c.currency&&c.currency.split(' ')[1]}{c.cost}</span></div>}
                    </div>
                    {c.note && <div style={{fontSize:11, color:G.sub, fontStyle:'italic', marginTop:4}}>{c.note}</div>}
                    <div style={{display:'flex', gap:6, marginTop:8}}>
                      <button onClick={() => {
                        setStF({date:c.date, estTime:c.estTime||'', cost:c.cost||'', currency:c.currency||'CNY Â¥', note:c.note||''});
                        setEditCId(c.id);
                        setShowST(true);
                        setTab(0);
                      }} style={{...S.gh, padding:'5px 9px', fontSize:11}}>{T.edit}</button>
                      <button onClick={() => setCommutes(cs => cs.filter(x => x.id!==c.id))} style={{...S.rd, padding:'5px 9px', fontSize:11}}>{T.del}</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* SETTINGS */}
        {tab===5 && <SettingsTab T={T} lang={lang} setLang={setLang} defCurr={defCurr} setDefCurr={setDefCurr} tripName={tripName} setTripName={setTripName}/>}

      </div>

      {/* MODALS */}
      <Modal show={showST} onClose={() => setShowST(false)} title={editCId ? T.edit + ' è¡Œç¨‹' : T.saveLog}>
        {editCId && (
          <div style={{marginBottom:12, fontSize:13, color:G.sub}}>
            {commutes.find(c=>c.id===editCId)?.from} â†’ {commutes.find(c=>c.id===editCId)?.to}
          </div>
        )}
        <div style={{marginBottom:10}}><Lbl t={T.date + ' *'}/><input style={S.inp} type="date" value={stF.date} onChange={e=>setStF(f=>({...f,date:e.target.value}))}/></div>
        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:8, marginBottom:10}}>
          <div><Lbl t={T.estTime}/><input style={S.inp} placeholder="4h 30m" value={stF.estTime} onChange={e=>setStF(f=>({...f,estTime:e.target.value}))}/></div>
          <div><Lbl t={T.cost}/><input style={S.inp} type="number" placeholder="0" value={stF.cost} onChange={e=>setStF(f=>({...f,cost:e.target.value}))}/></div>
        </div>
        <div style={{marginBottom:10}}><Lbl t={T.currency2}/><select style={{...S.inp, appearance:'none'}} value={stF.currency} onChange={e=>setStF(f=>({...f,currency:e.target.value}))}>{CURR.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
        <div style={{marginBottom:14}}><Lbl t={T.note}/><input style={S.inp} placeholder="é«˜éµ, TGV, EasyJet..." value={stF.note} onChange={e=>setStF(f=>({...f,note:e.target.value}))}/></div>
        <div style={{display:'flex', gap:10}}>
          <button style={{...S.gh, flex:1}} onClick={() => setShowST(false)}>{T.cancel}</button>
          <button style={{...S.gold, flex:2}} onClick={saveCommute}>{T.save}</button>
        </div>
      </Modal>

      <Modal show={showDF} onClose={() => {setShowDF(false); setEditDId(null);}} title={editDId ? T.edit+' æ—¥è¨˜' : T.addDiary}>
        <Photos photos={dPh} set={setDPh}/>
        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:8, marginBottom:10}}>
          <div><Lbl t={T.city + ' *'}/><input style={{...S.inp, borderColor: dF.city?G.br:'rgba(212,168,83,.4)'}} placeholder="åŒ—äº¬, Roma..." value={dF.city} onChange={e=>setDF(p=>({...p,city:e.target.value}))}/></div>
          <div><Lbl t={T.country}/><input style={S.inp} placeholder="ä¸­å›½, Italia..." value={dF.country} onChange={e=>setDF(p=>({...p,country:e.target.value}))}/></div>
        </div>
        {editCId && (
          <div style={{marginBottom:12, fontSize:13, color:G.sub}}>
            {commutes.find(c=>c.id===editCId)?.from} â†’ {commutes.find(c=>c.id===editCId)?.to}
          </div>
        )}
        <div style={{marginBottom:10}}><Lbl t={T.date + ' *'}/><input style={{...S.inp, borderColor: dF.date?G.br:'rgba(212,168,83,.4)'}} type="date" value={dF.date} onChange={e=>setDF(p=>({...p,date:e.target.value}))}/></div>
        <div style={{marginBottom:10}}><Lbl t={T.rating}/><Stars v={dF.rating} on={v=>setDF(p=>({...p,rating:v}))}/></div>
        <div style={{marginBottom:10}}><Lbl t={T.comment}/><textarea style={{...S.ta, minHeight:80}} value={dF.comment} onChange={e=>setDF(p=>({...p,comment:e.target.value}))} placeholder="ä½ çš„æ—…è¡Œå¿ƒå¾—..."/></div>
        <div style={{marginBottom:14}}><Lbl t={T.tags}/><input style={S.inp} value={dF.tags} onChange={e=>setDF(p=>({...p,tags:e.target.value}))} placeholder="ç¾é£Ÿ,æ‰“å¡,å¿…å»"/></div>
        <div style={{display:'flex', gap:10}}>
          <button style={{...S.gh, flex:1}} onClick={() => {setShowDF(false); setEditDId(null);}}>{T.cancel}</button>
          <button style={{...S.gold, flex:2, opacity:(!dF.city||!dF.date)?0.5:1}} onClick={submitD}>{T.save}</button>
        </div>
      </Modal>

      <Modal show={showEF} onClose={() => {setShowEF(false); setEditEId(null);}} title={editEId ? T.edit+' èŠ±è²»' : T.addExp}>
        <Photos photos={ePh} set={setEPh}/>
        <div style={{marginBottom:10}}><Lbl t={T.date}/><input style={S.inp} type="date" value={eF.date} onChange={e=>setEF(p=>({...p,date:e.target.value}))}/></div>
        <div style={{marginBottom:10}}><Lbl t={T.city}/><input style={S.inp} placeholder="Roma, åŒ—äº¬..." value={eF.city} onChange={e=>setEF(p=>({...p,city:e.target.value}))}/></div>
        <div style={{marginBottom:10}}><Lbl t={T.shop}/><input style={S.inp} placeholder="é¤å»³åã€æ™¯é»ã€é£¯åº—..." value={eF.shop} onChange={e=>setEF(p=>({...p,shop:e.target.value}))}/></div>
        <div style={{marginBottom:10}}>
          <Lbl t={T.category}/>
          <div style={{display:'flex', flexWrap:'wrap', gap:6}}>
            {EXP_CATS.map(c => <button key={c} onClick={() => setEF(p=>({...p,category:c}))} style={chip(eF.category===c, EXP_CLR[c])}>{c}</button>)}
          </div>
        </div>
        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:8, marginBottom:10}}>
          <div><Lbl t={T.amount}/><input style={S.inp} type="number" placeholder="0.00" value={eF.amount} onChange={e=>setEF(p=>({...p,amount:e.target.value}))}/></div>
          <div><Lbl t={T.currency2}/><select style={{...S.inp, appearance:'none'}} value={eF.currency} onChange={e=>setEF(p=>({...p,currency:e.target.value}))}>{CURR.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
        </div>
        <div style={{marginBottom:14}}><Lbl t={T.note}/><input style={S.inp} placeholder="å‚™æ³¨ï¼ˆé¸å¡«ï¼‰" value={eF.note} onChange={e=>setEF(p=>({...p,note:e.target.value}))}/></div>
        <div style={{display:'flex', gap:10}}>
          <button style={{...S.gh, flex:1}} onClick={() => {setShowEF(false); setEditEId(null);}}>{T.cancel}</button>
          <button style={{...S.gold, flex:2}} onClick={submitE}>{T.save}</button>
        </div>
      </Modal>

    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

</script>
</body>
</html>
